### 🎯 目标  
在 **不大幅 refactor** 的前提下，解决以下核心痛点：  

1. **授权混用** 导致 refresh token 始终为空、401 循环退出。  
2. **client secret 暴露** 与 Spotify Mobile SDK 政策冲突。  
3. 定时刷新、连接监听的竞争条件导致「假掉线／多重订阅」。  

最终达到——  
* App 能在 Android 真机上稳定登录、获取播放状态，token 过期后自动弹出一次登录重新授权。  
* 不再把 `clientSecret` 写进 APK，也不再依赖 `flutter_appauth`。  
* 代码改动尽量集中，Provider 层接口 **不变**，UI 无感知。  

---

## 🛠 最小改动策略  

| 组件 | 动作 | 说明 |
|------|------|------|
| **Auth 方案** | **仅保留 `spotify_sdk` 隐式 PKCE** | 移除所有 `flutter_appauth` & `clientSecret` 相关逻辑。无需刷新令牌，失效时重新调 `getAccessToken()`。 |
| **存储** | 只存 `access_token` & `expires_at` | `refresh_token` 字段留空即可。 |
| **Token 检查** | `isAuthenticated()` 判过期直接返回 `false` | 交由上层捕获后调用 `login()`，而不是内部强刷。 |
| **连接监听** | 监听逻辑只保留一处（AuthService） | Provider 不再单独订阅。 |
| **配置** | `clientId` 写死或走 SecureStorage；**删除 clientSecret** | `SpotifyDashboard` 仅需填 redirect URI。 |
| **Scope** | 精简为播放控制 + 库访问 | 删除 `app-remote-control`（如果暂不使用 Remote 功能，可一起删）。 |

---

## 📑 详细任务清单  

> **行号参考**＝你当前仓库里的行号，可能需根据 IDE 搜索关键词定位。  

| # | 文件 / 函数 | 改动说明 | 关键代码片段 |
|---|-------------|----------|--------------|
| 1 | **`spotify_service.dart`**<br>`SpotifyAuthService` 构造函数 | **去掉 `clientSecret` 参数**；删除所有写入/读取 `_refreshTokenKey` 的语句。 | ```dart<br>SpotifyAuthService({required this.clientId, required this.redirectUrl, ...});``` |
| 2 | 同文件<br>`defaultScopes` | 可保留：`user-read-email user-read-playback-state user-modify-playback-state user-library-read user-library-modify`<br>暂时 **移除 `app-remote-control`**。 | |
| 3 | 同文件<br>`login()` | - 删除 `flutter_appauth` 分支。<br>- 保留 `SpotifySdk.getAccessToken()` 路径。<br>- 成功后：`_saveAuthResponse(token, expiresAtNowPlus60m)`。 | ```dart<br>final token = await SpotifySdk.getAccessToken(...);<br>final expiresAt = DateTime.now().add(const Duration(hours:1));<br>await _saveAuthResponse(token, expiresAt);``` |
| 4 | 同文件<br>`isAuthenticated()` | 简化逻辑：若 `expires_at` < `DateTime.now()` 直接 `return false;`（**不要**自动刷新）。 | |
| 5 | 同文件<br>`refreshToken()` | 重命名为 `getNewToken()` 或直接 **删除整段**；Provider 不再调用。 | |
| 6 | 同文件<br>`_saveAuthResponse()` | 保留 `access_token / expires_at`，**不保存 refresh_token**。 | |
| 7 | 同文件<br>所有引用 `_refreshTokenKey` 的位置 | 统一删除。 | |
| 8 | **`spotify_provider.dart`**<br>`_initSpotifyService()` | 构造 `SpotifyAuthService` 时 **去掉 clientSecret**。 | |
| 9 | 同文件<br>`setClientCredentials()` / `resetClientCredentials()` | 只持久化/删除 `clientId`，不再涉及 `clientSecret`。 | |
| 10 | 同文件<br>`autoLogin()` & `login()` | - 捕获 `isAuthenticated()==false` → 调 `login()`。<br>- 去掉 `refreshToken()` 的调用。 | |
| 11 | **连接监听**<br>`SpotifyProvider._setupConnectionListener()` | **删除整函数及调用**；改在 `SpotifyAuthService._setupConnectionListener()` 内触发 `onConnected/onDisconnected` 回调（已存在）。 | |
| 12 | **`pubspec.yaml`** | 移除 `flutter_appauth` 依赖。确保 `spotify_sdk` 版本 ≥ 2.4.1。 | |
| 13 | **Android 项目**<br>`AndroidManifest.xml` | 保留 `intent-filter`：`<data android:scheme="spotoolfy" android:host="callback" />`。确保与 Spotify Dashboard redirect URI 匹配。 | |
| 14 | **iOS (可选)**<br>`Info.plist` | 配置 `LSApplicationQueriesSchemes` 中包含 `spotify`；新增 URL Scheme `spotoolfy`. | |

---

## ✅ 验收标准  

1. **首次登录**  
   * 点击「登录 Spotify」→ 弹出官方授权页 → 同意后返回 App。  
   * 控制台打印 **`Logged in as: <username>`**；`token` 写入 SecureStorage。  
2. **Token 失效**（可手动将系统时间拨快 2h 验证）：  
   * 下次访问 Web API 返回 401 → `isAuthenticated()` 判定为 `false` → UI 自动再弹授权页。  
   * 重新授权后功能恢复，无崩溃。  
3. **APK 安全审计**  
   * 用解包工具扫描 `.so / .dex`，**不出现明文 `clientSecret` 字符串**。  
4. **连接监听**  
   * 连续锁屏/解锁或杀掉 Spotify App 后，再返回你的 App 不会出现多次 `subscribeConnectionStatus()` 报错。  

---

## ⏱ 预估工时  

| 任务 | 工时 |
|------|------|
| 代码删除/修改 & 本地编译 | 1 h |
| Android 实机测试（首次登录＋过期模拟） | 1 h |
| iOS 适配（如需） | 1 h |
| 文档 / README 更新 | 0.5 h |
| **总计** | **≈ 3.5 h** |

---

## 📌 后续展望（可选）  

* 若后续需要 **后台静默刷新 + 长时间播放**，再考虑把 OAuth 流程迁到后端或改为 **Authorization-Code PKCE**。  
* 引入 `spotify_player` 或 `audio_service` 可在前台/后台音频体验上获得更多控制权。