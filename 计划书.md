下面这个做法几乎是所有「个人脚本 / CLI」都会采用的**最小骚动**方案：  
只做一次“游客登录”（拿到 cookie）——以后把这份 cookie 塞进任何 /weapi 请求，就再也不会碰到 `50000005 需要登录`。  

---

## 步骤一：获取游客 cookie

| 请求 | 说明 | 需加密 | 典型返回 | 参考 |
|------|------|--------|----------|------|
| `POST https://music.163.com/weapi/register/anonimous` | 官方叫“游客登录”/“匿名注册”，不需要账号密码 | **要**用同一套 asrsea 双层 AES + RSA 加密，但 **body 可以是空对象 `{}`** | `{"code":200,"cookie":"MUSIC_A=...; NMTID=...; ...", ...}` | citeturn12view0 |

> ⚠️ 互联网上常见的 `GET /register/anonimous` 示例是基于 **第三方 Node** 反向服务；  
> 在直接调用网易官服时，仍然走 /weapi/… 体系，需要加密，跟你现在的代码保持一致就行。

### 建议的封装

```dart
class _CookieStore {
  String? value;
  DateTime? expire;
}

final _guest = _CookieStore();

Future<String> _ensureGuestCookie() async {
  // 1. 如果已有且未过期，直接用
  if (_guest.value != null &&
      _guest.expire!.isAfter(DateTime.now().add(const Duration(minutes: 5)))) {
    return _guest.value!;
  }

  // 2. 没有就去注册
  final rsp = await http.post(
    Uri.parse('https://music.163.com/weapi/register/anonimous'),
    headers: _headers,
    body: _encryptRequest({}), // 空对象即可
  );

  final jsonRsp = json.decode(rsp.body);
  if (jsonRsp['code'] == 200) {
    _guest.value = jsonRsp['cookie'];
    // 官网 cookie 默认 24 h 过期，这里保守起见记 20 h
    _guest.expire = DateTime.now().add(const Duration(hours: 20));
    return _guest.value!;
  }
  throw Exception('游客登录失败: $jsonRsp');
}
```

---

## 步骤二：所有后续请求带 cookie

```dart
final cookie = await _ensureGuestCookie();
final resp = await http.post(
  Uri.parse('$_baseUrl/cloudsearch/get/web'),
  headers: {
    ..._headers,
    // 一定要带 os=pc，否则个别接口仍会 301
    'cookie': '$cookie; os=pc',
  },
  body: encryptedData,
);
```

`fetchLyric` 同理。

---

## 步骤三：自动失效与重试

1. **接口再次返回 50000005 / 301**  
   → 说明游客 cookie 到期或被清理，直接把 `_guest.value` 置空再调 `_ensureGuestCookie()`。
2. **-462 作弊检测**（偶尔触发）  
   → 给请求头加 `X-Real-IP: <你的出口 IP>` 或换个 User-Agent 即可。citeturn7search0

---

## 其他最佳实践

| 场景 | 建议 |
|------|------|
| **CLI 多次运行** | 把 `_guest.cookie` 序列化到本地文件，下一次启动先读出来（少打一条请求）。 |
| **高并发脚本** | 不要为每个线程都注册游客；1 个 IP 短时间注册太多会 403。 |
| **频繁失效** | 确认请求头里带了 `Referer: https://music.163.com/`、`User-Agent` 模拟 PC 浏览器，且 `cookie` 字段排在最前面；有些网关规则比较挑顺序。 |
| **真的想完全摆脱登录流程** | 把搜索 / 歌词接口改走 EAPI（`/eapi/cloudsearch/pc`、`/eapi/song/lyric`）。EAPI 天生自带游客态，无需任何 cookie，但要换成单层 AES-ECB(`e82ckenh8dichen8`) 加密。 |

---

### 一句话总结

> “一次游客登录，拿到 `MUSIC_A + NMTID` 这份 cookie，后面所有 /weapi 请求都带上它；失效就重新注册”——这是目前**最简洁、最稳定、最不需要手动账号**的做法，完全符合你“个人小工具 / CLI、不想登录账号”的需求。