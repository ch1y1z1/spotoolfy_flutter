## 问题回顾

1. **问题**
   \* iOS 上只要调用 `SpotifySdk.connectToSpotifyRemote()` 就会把正在电脑／音响播放的音乐「抢」到手机。
   \* 你的 `login()` / 自动续期流程默认都会 **先拿 token → 立刻连接 Remote**，导致静默续签也会抢设备。

2. **核心结论**

   * **“拿 / 刷 OAuth Token”** (`SpotifySdk.getAccessToken`) **≠** **“连 App Remote”** (`connectToSpotifyRemote`)。
   * 只要在静默续签、冷启动、后台唤醒时**不要调用 `connectToSpotifyRemote()`**，iOS 就不会抢播放。
   * 只有当你确实需要 Remote-级功能（实时订阅、硬件按键、CarPlay…）时，再去连接即可。

3. **可行做法**（包 `spotify_sdk` 本身完全支持）

   * 把现有 `login()` 拆成两步：

     1. **`ensureFreshToken()`** 只负责获取 / 刷新 token，并保存到 SecureStorage。
     2. **`connectRemoteIfNeeded()`** 检测当前是否已连 Remote，若没连则用有效 token 去连。
   * Provider 层：

     * 绝大部分纯 Web API 调用只需要 `ensureFreshToken()`。
     * 真正需要 Remote 时（播放 / 调音量 / 订阅 PlayerState）再调用 `connectRemoteIfNeeded()`。

---

## **一步一步修改指南**

> 以下步骤按最小改动量排列，基本不用动业务代码 UI。

### ① 在 `SpotifyAuthService` 里新增两个方法

```dart
// 1. 只管 token，不连 Remote
Future<String?> ensureFreshToken({List<String>? scopes}) async {
  // ① 读 secureStorage -> 看过期
  // ② 过期就调用 SpotifySdk.getAccessToken(...)
  // ③ 成功后保存 accessToken + 新过期时间
  // 返回 token；用户取消就返回 null
}

// 2. 需要 Remote 时再调
Future<bool> connectRemoteIfNeeded() async {
  final status = await SpotifySdk.getConnectionStatus();
  if (status.connected == true) return true;

  final tok = await ensureFreshToken();
  if (tok == null) return false;             // 让上层弹登录

  final ok = await SpotifySdk.connectToSpotifyRemote(
    clientId: clientId,
    redirectUrl: redirectUrl,
    accessToken: tok,
  );
  if (ok) _setupConnectionListener();
  return ok;
}
```

### ② 精简现有 `login()`

* 只做「**交互式获取一次 token** + 保存」，**不要**里面顺手 `connectToSpotifyRemote()`。
* 逻辑上等同于调用 `ensureFreshToken()`，但把 SDK 弹窗交给用户主动触发。

### ③ 静默续签路径改用 `ensureFreshToken()`

在

* 冷启动 `autoLogin()`
* App Resume（`_AppLifecycleObserver`）
* `_handleApiError` 里遇到 401
  都 **只** 调 `ensureFreshToken()`，不要再连 Remote。

### ④ Remote-级操作前加一行

在 Provider 里凡是 **依赖 Remote** 的方法，最前面插一句：

```dart
if (!await _spotifyService.connectRemoteIfNeeded()) {
  // token 不在 / 用户取消 -> 自己处理 UI
  return;
}
```

常见的有：

| 方法                                                       | 备注                                        |
| -------------------------------------------------------- | ----------------------------------------- |
| `togglePlayPause()`                                      | 若只是 Web API PUT，也可不要 Remote；但是你想用耳机按键就需要连 |
| `seekToPosition()` / `skipToNext()` / `skipToPrevious()` | 同上                                        |
| 任何监听 `SpotifySdk.subscribePlayerState()` 的页面             | 进入页面时先 `connectRemoteIfNeeded()`          |

### ⑤ 可选：给“后台自动重连”上开关，开关放在 login.dart 里

```dart
bool _autoReconnectRemote = false;        // 默认关

void enableAutoReconnect() => _autoReconnectRemote = true;
void disableAutoReconnect() => _autoReconnectRemote = false;

void _registerLifecycle() {
  _binding.addObserver(_AppLifecycleObserver(onResume: () async {
    await ensureFreshToken();             // 只续 token
    if (_autoReconnectRemote) {
      await connectRemoteIfNeeded();      // 可选：重新连 Remote
    }
  }));
}
```

用户想让手机接管播放时，在设置里打开即可。

---

## 最后自检清单 ✅

| 环节                   | 会不会连 Remote                | 会不会抢设备        |
| -------------------- | -------------------------- | ------------- |
| 冷启动 / 静默续签           | **不会**                     | ❌             |
| 手动登录按钮               | 不会（只拿 token）               | ❌             |
| 点击「播放」等需要 Remote 的操作 | 先判连 → 未连才连接                | **可能会**（符合预期） |
| App 恢复前台             | 取决于 `_autoReconnectRemote` | 可控            |

这样，你就既保住了「静默续期不抢设备」的体验，也保留了需要时连 Remote 的全部能力。

